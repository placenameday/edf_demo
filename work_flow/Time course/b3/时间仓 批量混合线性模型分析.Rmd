---
title: "Time_bin_mixed"
author: "Chen Xing"
date: '2022-05-18'
output: html_document
---

## 摘要
针对注视比例出时序图并进行mixed模型差异分析

### 必要的包
```{r, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(tidyverse)
library(lmerTest)
library(parameters)
library(effectsize)
library(emmeans)
library(performance)
library(sjPlot)
library(ggpubr)
library(rstatix)
```

### 读取数据初步时序图
```{r, message=FALSE, warning=FALSE}
dt <- read_csv("/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/ea/data/raw_time_b3.gz") %>%
  select(1:7,10,13)

dt2 <- dt %>% group_by(participant_phone, AOI, Time) %>%
  summarise(prop=mean(Prop, rm.na=T))

ggplot(dt2, aes(x=Time, y=prop, color=AOI)) +
  stat_summary(fun.y=mean, geom="point")
```


### 混合模型数据准备,初步进行各个时间段两两对比
```{r, message=FALSE, warning=FALSE}
dt3 <- dt
dt4 <- dt2

# 对AOI因子重新编码
dt3$AOI <- factor(dt3$AOI, levels=c("b3_ne", "b3_pos", "b3_neg", "b3_thr"))
contrasts(dt3$AOI) = contr.sum(4)

dt4$AOI <- factor(dt4$AOI, levels=c("b3_ne", "b3_pos", "b3_neg", "b3_thr"))
contrasts(dt4$AOI) = contr.sum(4)

dt4 <- dt3 %>% filter(Time==4000)

mm <- function(dt, t){
  dt4 <- dt %>% filter(Time==t)
  model <- lmer(Prop ~ AOI  + (1| participant_phone) + (1|trial_id),  data = dt4)
  
  pwc <- summary(pairs(emmeans(model, "AOI", lmerTest.limit = 10000))) %>% filter(p.value <0.05) %>%
    mutate(Time=t)
  pwc
}

tlist <- unique(dt3$Time)

k <- bind_rows(map(tlist, mm, dt=dt3))




mm2 <- function(dt, t){
  dt4 <- dt %>% filter(Time==t)
  model <- lmer(prop ~ AOI  + (1| participant_phone),  data = dt4)
  
  pwc <- summary(pairs(emmeans(model, "AOI", lmerTest.limit = 10000))) %>% filter(p.value <0.05) %>%
    mutate(Time=t)
  pwc
}

tlist <- unique(dt4$Time)

k2 <- bind_rows(map(tlist, mm2, dt=dt4))

k3 <- k2 %>% rowwise() %>%
  mutate(A1=str_split_fixed(contrast, " - ",2)[[1]], A2=str_split_fixed(contrast, " - ",2)[2]) %>%
  mutate(Big=case_when(estimate>0~A1,
                       estimate<0~A2),
         Small=case_when(estimate>0~A2,
                       estimate<0~A1))



```


### 初步进行各个时间段优势分析
```{r, message=FALSE, warning=FALSE}



```