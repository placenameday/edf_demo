---
title: "static_ana_1"
author: "Chen Xing"
date: '2022-04-21'
output: html_document
---

# 统计汇总各个静态指标

## 静态指标列表

### 通用指标

1.  **注视点类**
    1.  注视点个数（fixation count:fc）

    2.  平均注视点时长（average fixation duration:afd）

    3.  潜伏期（duration to first fixation:dff）

    4.  首视时长（first fixation duration:ffd）

    5.  瞳孔直径（pupil diameter:pd）

    6.  注视时长（fixation dwell time:dw）
2.  **眼跳类**
    1.  平均眼跳幅度（average saccade amplitude:asa）

    2.  眼跳个数（saccade count:sc）

    3.  扫视距离（saccade distance:sad）

    4.  平均眼跳时长（average saccade duration:asd）

    5.  眼跳峰值速度（saccade peak velocity:spv）

    6.  区间眼跳计数（saccade between count:sbc）

    7.  区间眼跳模式（saccade pattern:sacp）
3.  **眨眼类**
    1.  眨眼次数（blink count:bc）

    2.  眨眼时长（blink duration:bd）

以上指标分别对刺激**整体**及各个**AOI**进行统计。

```{r, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(tidyverse)
library(data.table)
library(furrr)
plan(multisession, workers = 6)
```

## 注视点类指标计算

### 方法定义

```{r, message=FALSE, warning=FALSE}
# 获取全部aoi名称
aoi_name_list <- unique(read_csv("/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/AOI_info_3.csv")$aoi_name)

# 对dt进行aoi信息整理
aoi_dt <- function(dt, aji=TRUE){
  # 取实际存在aoi信息
  aol_cols <- intersect(aoi_name_list, colnames(dt))
  aol_cols <- append(aol_cols,"bg")
    
  # AOI数据整理
  ndt <- pivot_longer(dt, cols = aol_cols, names_to = "AOI", values_to = "aj") %>%
    filter(!is.na(aj), aj %in% aji) %>%
    filter(!((block_name %in% c("b1a","b1b"))&stim==1&(str_starts(AOI, "^b1_2_")))) %>%
    filter(!((block_name %in% c("b1a","b1b"))&stim %in% c(2,3,4,5)&(str_starts(AOI, "^b1_1")))) %>%
    filter(!((block_name == "b2")&stim==1&(AOI %in% c("b2_star", "b2_no_star")))) %>%
    filter(!((block_name == "b2")&stim==2&(AOI %in% c("b2_xj", "b2_jj", "b2_sp", "b2_n"))))
}


fix_s <- function(file_path, out_path){
  # 数据读取
  dt <- fread(file_path)
  
  # 统计整体数据
  a <- dt %>% filter(stim!=0, !is.na(axp)) %>% group_by(participant_group, participant_phone,block_name, type, block, trial_name, stim) %>%
    summarise(fc=n(), afd=mean(dur), dff=min(stime_p), ffd=dur[1], pd=mean(aps), dw=sum(dur)) %>%
    mutate(AOI = "Overall")
  
  # 统计AOI数据
  b <- aoi_dt(dt) %>% filter(stim!=0, !is.na(axp)) %>% group_by(participant_group, participant_phone,block_name, type, block, trial_name, stim, AOI) %>%
    select(-aj) %>%
    summarise(fc=n(), afd=mean(dur), dff=min(stime_p), ffd=dur[1], pd=mean(aps), dw=sum(dur))
  
  # 数据整合
  c <- suppressMessages(full_join(a,b) %>% arrange(block, stim, AOI))
  write_csv(c, file=gzfile(out_path))
  gc()
}

# 批量处理方法
multi_p <- function(in_dir, out_dir, method){
  if (!dir.exists(out_dir)) {
    dir.create(out_dir)
  }
  out_list <- paste(out_dir,"/",list.files(in_dir), ".gz", sep = "")
  in_list <- paste(in_dir,"/",list.files(in_dir), sep = "")
  future_map2(in_list, out_list, method)
  gc()
}

fix_in <- "/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/fix_clean_aoi"
fix_out <- "/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/fix_static_ana"
```

### 批量处理

运行函数进行批量处理`multi_p(fix_in, fix_out, fix_s)`

## 眼跳类指标计算
### 整体及Inner眼跳
#### 方法定义
```{r, message=FALSE, warning=FALSE}
sacc_inner <- function(file_path, out_path){
  # 数据读取
  dt <- fread(file_path)
  
  # 统计整体数据
  a <- dt %>% filter(stim!=0, !is.na(sxp)) %>% group_by(participant_group, participant_phone,block_name, type, block, trial_name, stim) %>%
    summarise(asa=mean(ampl), sc=n(), sad=sum(ampl), asd=mean(dur), spv=mean(pv)) %>%
    mutate(AOI = "Overall")
  
  # 统计AOI数据
  b <- aoi_dt(dt, aji = "Inner") %>% filter(stim!=0, !is.na(sxp)) %>% group_by(participant_group, participant_phone,block_name, type, block, trial_name, stim, AOI) %>%
    select(-aj) %>%
    summarise(asa=mean(ampl), sc=n(), sad=sum(ampl), asd=mean(dur), spv=mean(pv))
  
  # 数据整合
  c <- suppressMessages(full_join(a,b) %>% arrange(block, stim, AOI))
  write_csv(c, file=gzfile(out_path))
  gc()
}

sacc_inner_in <- "/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/sacc_clean_re_aoi_multi"
sacc_inner_out <- "/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/sacc_inner_static_ana"
```

#### 批量处理

运行函数进行批量处理`multi_p(sacc_inner_in, sacc_inner_out, sacc_inner)`

### 区间眼跳
#### 方法定义
```{r, message=FALSE, warning=FALSE}
bdd <- fread("/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/sacc_clean_re_aoi_multi/4037_sacc.csv.gz")

aoi_p_d <- function(aoi_name){
  big <- c("out","all","b1_1","b1_2","b4","b5","b2_1_f","b2_1_e","b2_2","b2_cen","b3_1","b3_2","bg")
  small <- c("out","b1_2","b4","b5","b2_1_f","b2_1_e","b2_2","b2_cen","bg")
  k <- if_else(str_detect(aoi_name, "ouuter_"),list(agn="out", hand=big),
        if_else(str_detect(aoi_name,"all_"),list(agn="all",hand=c("out","all")),
        if_else(str_detect(aoi_name,"b1_1"),list(agn="b1_1",hand=c("out","b1_1")),
        if_else(str_detect(aoi_name,"b1_2"),list(agn="b1_2",hand=c("out","b1_2","bg")),
        if_else(str_detect(aoi_name,"b4"),list(agn="b4",hand=c("out","b4","bg")),
        if_else(str_detect(aoi_name,"b5_"),list(agn="b5",hand=c("out","b5","bg")),
        if_else(aoi_name %in% c("b2_left", "b2_right"),list(agn="b2_1_f",hand=c("out","b2_1_f", "cen","bg")),
        if_else(aoi_name %in% c("b2_jj", "b2_n", "b2_sp", "b2_xj"),list(agn="b2_1_e",hand=c("out","b2_1_e", "cen","bg")),
        if_else(aoi_name %in% c("b2_star", "b2_no_star"),list(agn="b2_2",hand=c("out","b2_2", "cen","bg")),
        if_else(aoi_name %in% c("b2_center"),list(agn="b2_cen",hand=c("out", "b2_cen","bg","b2_2","b2_1_e","b2_1_f")),
        if_else(aoi_name %in% c("b3_lt", "b3_rt", "b3_lb", "b3_rb"),list(agn="b3_1",hand=c("out","b3_1")),
        if_else(aoi_name %in% c("b3_ne", "b3_neg", "b3_pos", "b3_thr"),list(agn="b3_2",hand=c("out","b3_2")),
        if_else(aoi_name %in% c("bg"),list(agn="bg",hand=small),list(agn="other",hand=c("")))))))))))))))
}


b_dt <-aoi_dt(bdd, c("S", "E")) %>% rowwise() %>%
  mutate(AOI_P = list(aoi_p_d(AOI)))
b_dt_w <- pivot_wider(b_dt, names_from = aj, values_from = AOI)
map(b_dt_w$E, unlist)

tdte <- b_dt_w$E[2][[1]]
tdts <- b_dt_w$S[2][[1]]

pipei <- function(stri){
  partern <- str_sub(stri, 1,3)
}

make_par <- function(par,s,e){
  ss <- str_subset(s,par)
  ee <- str_subset(e,par)
  paste(ss,"--",ee,sep = "")
}

row_p <- function(tdts, tdte){
  par_list <- unlist(map(tdts, pipei))
  pa <- map(par_list, make_par, s=tdts, e=tdte)
}

kk <- b_dt_w %>% rowwise() %>%
  mutate(patern=list(row_p(S,E)))

```


## 眨眼类指标计算
### 方法定义
```{r, message=FALSE, warning=FALSE}
blink_s <- function(file_path, out_path){
  # 数据读取
  dt <- fread(file_path)
  
  # 统计整体数据
  a <- dt %>% filter(stim!=0, !is.na(dur)) %>% group_by(participant_group, participant_phone,block_name, type, block, trial_name, stim) %>%
    summarise(bc=n(), bd=mean(dur)) %>%
    mutate(AOI = "Overall") %>% arrange(block, stim)

  write_csv(a, file=gzfile(out_path))
  gc()
}

blink_in <- "/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/blinks_clean"
blink_out <- "/Users/placenameday/R study/edf_demo/data/processed/eye_tacking/tidy/blinks_static_ana"
```

### 批量处理

运行函数进行批量处理`multi_p(blink_in, blink_out, blink_s)`